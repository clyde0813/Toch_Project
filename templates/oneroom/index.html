{% extends 'base.html' %}
{% block content %}
    <div class="loading_page none" style="height: 100vh; opacity: 0.5; z-index: 4; background-image: url(../../static/images/ai_loading.gif);  background-size: 10%"></div>

    <div class="subPage oneRoomPage">
        <section class="oneRoomArea">
            <h2 class="hidden">원룸</h2>
            <div class="contArea">
                <div class="mapArea">
                    <div class="inputArea">
                        <div class="seachBox">
                            <input type="search">
                            <button>검색버튼</button>
                        </div>
                        <button data-popup="filter_box">필터</button>
                        <div class="filter_box">
                            <form>
                                <fieldset>
                                    <div>
                                        <button>초기화</button>
                                    </div>
                                    <ul>
                                        <li>
                                            <label>반려동물</label>
                                            <div>
                                                <input type="radio" name="pet" value="1">
                                                <label>Yes</label>
                                                <input type="radio" name="pet" value="0">
                                                <label>No</label>
                                            </div>
                                        </li>
                                        <li>
                                            <label>자차보유</label>
                                            <div>
                                                <input type="radio" name="car" value="1">
                                                <label>Yes</label>
                                                <input type="radio" name="car" value="0">
                                                <label>No</label>
                                            </div>
                                        </li>
                                        <li>
                                            <label>외향/내향</label>
                                            <div>
                                                <input type="radio" name="personality" value="1">
                                                <label>Yes</label>
                                                <input type="radio" name="personality" value="0">
                                                <label>No</label>
                                            </div>
                                        </li>
                                    </ul>
                                    <button class="ai_reco_btn">Toch  AI 추천</button>
                                    <span class="material-icons-outlined closeBtn">
                                        close
                                    </span>
                                </fieldset>
                            </form>
                        </div>

                        <button data-popup="AI_box">AI 추천</button>

                        <div class="AI_box">
                            <form>
                                <fieldset>
                                    <div>
                                        <button>초기화</button>
                                    </div>

                                    <ul>
                                        <li>
                                            <label>거래유형</label>
                                            <mark>연세</mark>
                                            <div>
                                                <input type="radio" checked>
                                                <label>연세</label>
                                                <input type="radio">
                                                <label>월세</label>
                                                <input type="radio">
                                                <label>전세</label>
                                            </div>
                                        </li>
                                        <li>
                                            <label>보증금</label>
                                            <mark>500만원</mark>
{#                                            <label for="deposit_range"></label>#}
                                            <div>
                                                <div class="rangeBox">
                                                    <div>
                                                        <span></span>
                                                        <span>
                                                            <span>500만원</span>
                                                        </span>
{#                                                        <input type="range" id="deposit_range" name="deposit_range" min="0" max="5000" step="100">#}
                                                    </div>
                                                </div>
                                            </div>
                                        </li>
                                        <li>
                                            <label>월세</label>
                                            <mark>500만원</mark>
                                            <div>
                                                <div class="rangeBox">
                                                    <div>
                                                        <span></span>
                                                        <span>
                                                            <span>500만원</span>
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>
                                        </li>
                                    </ul>

                                    <span class="material-icons-outlined closeBtn">
                                        close
                                    </span>
                                </fieldset>
                            </form>
                        </div>
                    </div>



                    <div class="myMap"></div>
                </div>
                <div class="listArea">
                    <div class="bottomArea">
                        <ul>
                        </ul>
                    </div>
                </div>
            </div>
        </section>
    </div>
    <script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=98a0001a3486109fd99e7a58b946cfbe&libraries=clusterer,services"></script>
    <script src="../static/scripts/com.js"></script>
    <script type="text/javascript">
        const container = document.querySelector('.myMap');
        const itemList = document.querySelector('.bottomArea > ul');
        const MNU_LATITUDE = 34.91124654247272;
        const MNU_LONGITUDE = 126.43614580709644;

        let imageSrc = '../../static/images/maker.png', // 마커이미지의 주소입니다
            imageSize = new kakao.maps.Size(30, 30), // 마커이미지의 크기입니다
            imageOption = {offset: new kakao.maps.Point(10, 30)}; // 마커이미지의 옵션입니다. 마커의 좌표와 일치시킬 이미지 안에서의 좌표를 설정합니다.

        // 마커를 표시할 위치와 해당 정보를 담은 배열
        let tmp_list = [];
        let positions = [];
        if (tmp_list.length) {
            for (let j in tmp_list) {
                {% if data %}
                    {% for i in data %}
                        if (Number(j) === {{ i.id }}) {
                            positions.push({
                                id: {{ i.id }},
                                title: '{{ i.title }}',
                                rent_type: '{{ i.rent_type }}',
                                rent_amount: '{{ i.rent_amount }}',
                                deposit: '{{ i.deposit }}',
                                latlng: new kakao.maps.LatLng({{ i.latitude }}, {{ i.longitude }}), // 원룸 좌표
                                main_img: '{{ i.file_set.first.file.url }}',
                                floor_num: '{{ i.floor_num }}',
                                common_area: '{{ i.common_area }}',
                                address: '{{ i.address }}',
                                manage_amount: '{{ i.manage_amount }}'
                            })
                        }
                    {% endfor %}
                {% endif %}
            }
        } else {
            {% if data %}
                {% for i in data %}
                    positions.push({
                        id: {{ i.id }},
                        title: '{{ i.title }}',
                        rent_type: '{{ i.rent_type }}',
                        rent_amount: '{{ i.rent_amount }}',
                        deposit: '{{ i.deposit }}',
                        latlng: new kakao.maps.LatLng({{ i.latitude }}, {{ i.longitude }}), // 원룸 좌표
                        main_img: '{{ i.file_set.first.file.url }}',
                        floor_num: '{{ i.floor_num }}',
                        common_area: '{{ i.common_area }}',
                        address: '{{ i.address }}',
                        manage_amount: '{{ i.manage_amount }}'
                    })
                {% endfor %}
            {% endif %}
        }

        const options = {
            center: new kakao.maps.LatLng(MNU_LATITUDE, MNU_LONGITUDE), // 지도의 중심 좌표
            level: 5 // 지도의 레벨(확대, 축소 정도)
        };

        let map = new kakao.maps.Map(container, options); //지도 생성 및 객체 리턴

        for (let i = 0, len = positions.length; i < len; i++) {
            let info = {
                id: positions[i].id,
                title: positions[i].title,
                rent_type: positions[i].rent_type,
                rent_amount: positions[i].rent_amount,
                deposit: positions[i].deposit,
                main_img: positions[i].main_img,
                floor_num: positions[i].floor_num,
                common_area: positions[i].common_area,
                address: positions[i].address,
                manage_amount: positions[i].manage_amount
            }
            // 마커를 생성하고 지도위에 표시합니다
            addMarker(positions[i].latlng, info);
            // 아이템 모두 표시
            showAllItems(info);
        }

        // 마커를 생성하고 지도 위에 표시하고, 마커에 mouseover, mouseout, click 이벤트를 등록하는 함수입니다
        function addMarker(latlng, info) {
            // 마커의 이미지정보를 가지고 있는 마커이미지를 생성합니다
            var markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize, imageOption),
                markerPosition = latlng; // 마커가 표시될 위치입니다

            // 마커를 생성합니다
            var marker = new kakao.maps.Marker({
                position: markerPosition,
                image: markerImage // 마커이미지 설정
            });

            // 마커에 click 이벤트를 등록합니다
            kakao.maps.event.addListener(marker, 'click', function () {
                // 기존 item 들을 삭제합니다.
                while (itemList.firstChild) {
                    itemList.removeChild(itemList.firstChild);
                }
                // 클릭한 마커에 해당되는 list 보여주기
                setListItem(info);
            });
            // 마커가 지도 위에 표시되도록 설정합니다
            marker.setMap(map);
        }

        ////////////////////////////////////////////////////////////////////////////// CUSTOM

        // 첫 로드시 리스트에 방들을 전부 보여주는 함수
        function showAllItems(info) {
            const roomInfo = roomListItem(info);

            itemList.insertAdjacentHTML('beforeend', roomInfo);
        }

        // 마커 클릭시 리스트에 방들을 보여주는 함수
        function setListItem(info) {
            const roomInfo = roomListItem(info);
            itemList.innerHTML = roomInfo;
        }

        function roomListItem(info) {
            return ` <li>
                 <a onclick="location.href=${info.id}">
                     <div class="imgBox" style="background-image: url(${info.main_img})"></div>

                     <div class="textArea">
                         <strong>
                             <small>${info.title}</small>
                             ${info.rent_type} ${info.deposit} / ${info.rent_amount}
                         </strong>
                         <p>${info.floor_num}층 ${info.common_area}㎡ 관리비 ${info.manage_amount}만원</p>
                         <p>${info.address}</p>
                         <div>
                             <span>원룸</span>
                             <span>공대근처</span>
                             <span>다이소근처</span>
                         </div>
                     </div>
                 </a>
             </li>
            `
        }

        //////////////////////////////////////////////////////////////
        /////////////////////// 추천 알고리즘 코드  //////////////////////
        //////////////////////////////////////////////////////////////
        const ai_reco_btn = document.querySelector('.ai_reco_btn');
        ai_reco_btn.addEventListener('click', e => {
            e.preventDefault();
            const loading_page = document.querySelector('.loading_page');
            loading_page.classList.remove('none');
            setTimeout(() => { loading_page.classList.add('none'); fetchData(); }, 2000)
            //setTimeout(() => , 600);
            //fetchData();
        })

        function getUserAI() {
            const pet = document.getElementsByName('pet');
            const car = document.getElementsByName('car');
            const personality = document.getElementsByName('personality');

            const userAi = {};

            for(let i=0; i<pet.length; i++) {
                if (pet[i].checked) {
                    userAi['A'] = pet[i].value;
                }
            }

            for(let i=0; i<pet.length; i++) {
                if (car[i].checked) {
                    userAi['B'] = car[i].value;
                }
            }

            for(let i=0; i<pet.length; i++) {
                if (personality[i].checked) {
                    userAi['C'] = personality[i].value;
                }
            }

            pet.checked = false;
            car.checked = false;
            personality.checked = false;

            return userAi
        }

        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = jQuery.trim(cookies[i]);
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }


         // 산술평균 값 key로 정렬
        function arithmeticMean(json, ai) {
            let keys = Object.keys(json[0]);
            let arithmeticMean = {}

            for (let i = 0; i < json.length; i++) {
                let sum = 0
                let post = json[i][keys[0]];


                for (let k = 1; k < keys.length; k++) {
                    let post_score = json[i][keys[k]];
                    //console.log('post_ : ' + post_score);
                    sum += post_score * ai[keys[k]]
                }
                arithmeticMean[post] = sum
            }

            return Object.keys(arithmeticMean).sort((a, b) => {
                return arithmeticMean[b] - arithmeticMean[a]
            });
        }

        // JSON 데이터 받아오는 함수
        function fetchData() {
            fetch('http://toch.kr/api/oneroom/')
                .then(response => response.json())
                .then(data => {
                    let userPreference = getUserAI();

                    tmp_list = arithmeticMean(data, userPreference);
                    console.log(tmp_list);

                    map = new kakao.maps.Map(container, options); //지도 생성 및 객체 리턴
                    positions = [];
                    while(itemList.firstChild) {
                        itemList.removeChild(itemList.firstChild);
                    }

                    for (let j in tmp_list) {
                        {% if data %}
                            {% for i in data %}
                                if (Number(tmp_list[j])  === {{ i.id }}) {
                                    positions.push({
                                        id: {{ i.id }},
                                        title: '{{ i.title }}',
                                        rent_type: '{{ i.rent_type }}',
                                        rent_amount: '{{ i.rent_amount }}',
                                        deposit: '{{ i.deposit }}',
                                        latlng: new kakao.maps.LatLng({{ i.latitude }}, {{ i.longitude }}), // 원룸 좌표
                                        main_img: '{{ i.file_set.first.file.url }}',
                                        floor_num: '{{ i.floor_num }}',
                                        common_area: '{{ i.common_area }}',
                                        address: '{{ i.address }}',
                                        manage_amount: '{{ i.manage_amount }}'
                                    })
                                }
                            {% endfor %}
                        {% endif %}
                    }
                    for (let i = 0, len = positions.length; i < len; i++) {
                        let info = {
                            id: positions[i].id,
                            title: positions[i].title,
                            rent_type: positions[i].rent_type,
                            rent_amount: positions[i].rent_amount,
                            deposit: positions[i].deposit,
                            main_img: positions[i].main_img,
                            floor_num: positions[i].floor_num,
                            common_area: positions[i].common_area,
                            address: positions[i].address,
                            manage_amount: positions[i].manage_amount
                        }
                        // 마커를 생성하고 지도위에 표시합니다
                        addMarker(positions[i].latlng, info);
                        // 아이템 모두 표시
                        showAllItems(info);
                    }
                })
        }
        </script>
    <script>
        $(document).ready(function(){
            $('[data-popup]').click(function(e){
                e.preventDefault();
                $('[class*="box"]').removeClass('active');
                var popupArea = $(this).siblings('.' + $(this).attr('data-popup'));
                if(popupArea.length == 0){
                    popupArea = $('.' + $(this).attr('data-popup'));
                }
                popupArea.addClass('active');
                popupArea.click(function(e){
                    e.stopPropagation();

                })
                popupArea.find('.closeBtn').click(function(){
                    popupArea.removeClass('active')
                })
                popupArea.children('div').click(function(e){
                    e.stopPropagation();
                })
            })
        })
    </script>
{% endblock %}